<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - CPL Analytics API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cpl: {
                            red: '#c8102e',
                            dark: '#1a1a2e',
                            darker: '#12121f',
                            card: '#252540'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-cpl-dark text-gray-100 min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-8">

        <!-- Header -->
        <header class="flex items-center justify-between py-6 border-b border-gray-700 mb-8">
            <div>
                <a href="/" class="text-gray-400 hover:text-white text-sm">&larr; Back to API</a>
                <h1 class="text-3xl font-bold mt-2">
                    <span class="text-cpl-red">Admin</span> Dashboard
                </h1>
                <p class="text-gray-400 mt-1">API Usage Analytics</p>
            </div>
            <div class="text-right">
                <div id="last-updated" class="text-gray-500 text-sm">Loading...</div>
                <button onclick="refreshData()" class="mt-2 bg-cpl-red hover:bg-red-700 text-white px-4 py-2 rounded text-sm transition">
                    Refresh
                </button>
            </div>
        </header>

        <!-- Summary Stats -->
        <section class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8">
            <div class="stat-card bg-cpl-card rounded-lg p-5 text-center">
                <div id="stat-today" class="text-3xl font-bold text-cpl-red">-</div>
                <div class="text-gray-400 text-sm">Today</div>
            </div>
            <div class="stat-card bg-cpl-card rounded-lg p-5 text-center">
                <div id="stat-week" class="text-3xl font-bold text-blue-400">-</div>
                <div class="text-gray-400 text-sm">This Week</div>
            </div>
            <div class="stat-card bg-cpl-card rounded-lg p-5 text-center">
                <div id="stat-month" class="text-3xl font-bold text-green-400">-</div>
                <div class="text-gray-400 text-sm">This Month</div>
            </div>
            <div class="stat-card bg-cpl-card rounded-lg p-5 text-center">
                <div id="stat-alltime" class="text-3xl font-bold text-purple-400">-</div>
                <div class="text-gray-400 text-sm">All Time</div>
            </div>
            <div class="stat-card bg-cpl-card rounded-lg p-5 text-center">
                <div id="stat-unique" class="text-3xl font-bold text-yellow-400">-</div>
                <div class="text-gray-400 text-sm">Unique IPs</div>
            </div>
            <div class="stat-card bg-cpl-card rounded-lg p-5 text-center">
                <div id="stat-uptime" class="text-3xl font-bold text-teal-400">-</div>
                <div class="text-gray-400 text-sm">Uptime (min)</div>
            </div>
        </section>

        <!-- Charts Row -->
        <section class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- Hourly Traffic Chart -->
            <div class="bg-cpl-card rounded-lg p-5">
                <h2 class="text-lg font-semibold text-cpl-red mb-4">Hourly Traffic (Last 24h)</h2>
                <div class="h-64">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>

            <!-- Endpoint Distribution Chart -->
            <div class="bg-cpl-card rounded-lg p-5">
                <h2 class="text-lg font-semibold text-cpl-red mb-4">Endpoint Distribution</h2>
                <div class="h-64">
                    <canvas id="endpointChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Endpoint Stats Table -->
        <section class="bg-cpl-card rounded-lg p-5 mb-8">
            <h2 class="text-lg font-semibold text-cpl-red mb-4">Endpoint Performance</h2>
            <table class="w-full">
                <thead class="bg-cpl-darker">
                    <tr>
                        <th class="text-left p-3 text-gray-400 text-sm">Endpoint</th>
                        <th class="text-right p-3 text-gray-400 text-sm">Calls</th>
                        <th class="text-right p-3 text-gray-400 text-sm">Avg Response</th>
                        <th class="text-right p-3 text-gray-400 text-sm">Errors</th>
                        <th class="text-right p-3 text-gray-400 text-sm">Error Rate</th>
                    </tr>
                </thead>
                <tbody id="endpoint-table">
                    <tr><td colspan="5" class="p-4 text-center text-gray-500">Loading...</td></tr>
                </tbody>
            </table>
        </section>

        <!-- Two Column Layout -->
        <section class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- Recent Requests -->
            <div class="bg-cpl-card rounded-lg p-5">
                <h2 class="text-lg font-semibold text-cpl-red mb-4">Recent Requests</h2>
                <div id="recent-requests" class="space-y-2 max-h-80 overflow-y-auto">
                    <div class="text-gray-500 text-center py-4">Loading...</div>
                </div>
            </div>

            <!-- Geographic Distribution -->
            <div class="bg-cpl-card rounded-lg p-5">
                <h2 class="text-lg font-semibold text-cpl-red mb-4">Geographic Distribution</h2>
                <div id="geo-distribution" class="space-y-2 max-h-80 overflow-y-auto">
                    <div class="text-gray-500 text-center py-4">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Rate Limit Info -->
        <section class="bg-cpl-card rounded-lg p-5 mb-8">
            <h2 class="text-lg font-semibold text-cpl-red mb-4">Rate Limit Configuration</h2>
            <div class="grid md:grid-cols-3 gap-4">
                <div class="bg-cpl-darker rounded p-4">
                    <div class="text-2xl font-bold text-yellow-400">20</div>
                    <div class="text-gray-400 text-sm">Requests per hour</div>
                </div>
                <div class="bg-cpl-darker rounded p-4">
                    <div class="text-2xl font-bold text-yellow-400">Per IP</div>
                    <div class="text-gray-400 text-sm">Rate limit scope</div>
                </div>
                <div class="bg-cpl-darker rounded p-4">
                    <div class="text-2xl font-bold text-yellow-400">429</div>
                    <div class="text-gray-400 text-sm">Status when exceeded</div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center py-6 border-t border-gray-700">
            <p class="text-gray-500 text-sm">
                Note: Analytics are stored in-memory and reset on server cold starts.
                <br>For production, consider using Vercel KV or external database.
            </p>
        </footer>
    </div>

    <script>
        let hourlyChart = null;
        let endpointChart = null;

        async function fetchAnalytics() {
            try {
                const response = await fetch('/api/analytics');
                if (!response.ok) throw new Error('Failed to fetch analytics');
                return await response.json();
            } catch (error) {
                console.error('Error fetching analytics:', error);
                return null;
            }
        }

        function updateSummaryStats(data) {
            if (!data || !data.summary) return;

            document.getElementById('stat-today').textContent = data.summary.today.toLocaleString();
            document.getElementById('stat-week').textContent = data.summary.thisWeek.toLocaleString();
            document.getElementById('stat-month').textContent = data.summary.thisMonth.toLocaleString();
            document.getElementById('stat-alltime').textContent = data.summary.allTime.toLocaleString();
            document.getElementById('stat-unique').textContent = data.summary.uniqueIPs.toLocaleString();
            document.getElementById('stat-uptime').textContent = data.summary.uptime.toLocaleString();

            document.getElementById('last-updated').textContent =
                `Last updated: ${new Date(data.generatedAt).toLocaleTimeString()}`;
        }

        function updateHourlyChart(data) {
            if (!data || !data.hourly) return;

            const ctx = document.getElementById('hourlyChart').getContext('2d');

            const labels = data.hourly.map(h => {
                const date = new Date(h.hour);
                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            });
            const calls = data.hourly.map(h => h.calls);
            const uniqueIPs = data.hourly.map(h => h.uniqueIPs);

            if (hourlyChart) {
                hourlyChart.destroy();
            }

            hourlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'API Calls',
                            data: calls,
                            borderColor: '#c8102e',
                            backgroundColor: 'rgba(200, 16, 46, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Unique IPs',
                            data: uniqueIPs,
                            borderColor: '#60a5fa',
                            backgroundColor: 'rgba(96, 165, 250, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#9ca3af' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#6b7280', maxTicksLimit: 8 },
                            grid: { color: 'rgba(107, 114, 128, 0.2)' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#6b7280' },
                            grid: { color: 'rgba(107, 114, 128, 0.2)' }
                        }
                    }
                }
            });
        }

        function updateEndpointChart(data) {
            if (!data || !data.endpoints) return;

            const ctx = document.getElementById('endpointChart').getContext('2d');

            const endpoints = Object.keys(data.endpoints);
            const calls = endpoints.map(e => data.endpoints[e].calls);
            const colors = ['#c8102e', '#60a5fa', '#4ade80', '#fbbf24', '#a855f7'];

            if (endpointChart) {
                endpointChart.destroy();
            }

            endpointChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: endpoints,
                    datasets: [{
                        data: calls,
                        backgroundColor: colors.slice(0, endpoints.length),
                        borderColor: '#1a1a2e',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#9ca3af', padding: 20 }
                        }
                    }
                }
            });
        }

        function updateEndpointTable(data) {
            if (!data || !data.endpoints) return;

            const tbody = document.getElementById('endpoint-table');
            tbody.innerHTML = Object.entries(data.endpoints).map(([endpoint, stats]) => `
                <tr class="border-t border-gray-700">
                    <td class="p-3 font-mono text-sm">${endpoint}</td>
                    <td class="p-3 text-right">${stats.calls.toLocaleString()}</td>
                    <td class="p-3 text-right ${stats.avgResponseTime > 500 ? 'text-yellow-400' : 'text-green-400'}">
                        ${stats.avgResponseTime}ms
                    </td>
                    <td class="p-3 text-right ${stats.errors > 0 ? 'text-red-400' : 'text-gray-400'}">
                        ${stats.errors}
                    </td>
                    <td class="p-3 text-right ${parseFloat(stats.errorRate) > 5 ? 'text-red-400' : 'text-gray-400'}">
                        ${stats.errorRate}
                    </td>
                </tr>
            `).join('');
        }

        function updateRecentRequests(data) {
            if (!data || !data.recentRequests) return;

            const container = document.getElementById('recent-requests');

            if (data.recentRequests.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-4">No recent requests</div>';
                return;
            }

            container.innerHTML = data.recentRequests.map(req => {
                const statusColor = req.statusCode < 400 ? 'text-green-400' :
                                   req.statusCode < 500 ? 'text-yellow-400' : 'text-red-400';
                const time = new Date(req.timestamp).toLocaleTimeString();

                return `
                    <div class="bg-cpl-darker rounded p-3 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="font-mono">${req.endpoint}</span>
                            <span class="${statusColor}">${req.statusCode}</span>
                        </div>
                        <div class="flex justify-between items-center mt-1 text-gray-500 text-xs">
                            <span>${req.ip}</span>
                            <span>${req.responseTime}ms | ${time}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateGeoDistribution(data) {
            if (!data || !data.countries) return;

            const container = document.getElementById('geo-distribution');

            if (data.countries.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-4">No geographic data available</div>';
                return;
            }

            const maxCount = Math.max(...data.countries.map(c => c.count));

            container.innerHTML = data.countries.map(({ country, count }) => {
                const percentage = (count / maxCount * 100).toFixed(0);
                return `
                    <div class="flex items-center gap-3">
                        <div class="w-12 text-sm font-mono">${country}</div>
                        <div class="flex-1 bg-cpl-darker rounded-full h-4 overflow-hidden">
                            <div class="bg-cpl-red h-full rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <div class="w-16 text-right text-sm text-gray-400">${count.toLocaleString()}</div>
                    </div>
                `;
            }).join('');
        }

        async function refreshData() {
            const data = await fetchAnalytics();
            if (data) {
                updateSummaryStats(data);
                updateHourlyChart(data);
                updateEndpointChart(data);
                updateEndpointTable(data);
                updateRecentRequests(data);
                updateGeoDistribution(data);
            }
        }

        // Initial load
        refreshData();

        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);
    </script>
</body>
</html>
